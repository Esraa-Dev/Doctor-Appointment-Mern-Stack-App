import mongoose, { Schema, Document } from "mongoose";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import {
  AccessTokenExpire,
  RefreshTokenExpire,
  UserRole,
} from "../constants.js";
import Joi from "joi";

export interface IUser extends Document {
  firstName: string;
  lastName: string;
  email: string;
  password: string;
  image?: string;
  phone: string;
  role: UserRole;
  isEmailVerified: boolean;
  verifyOtp?: string;
  verifyOtpExpireAt?: Date;
  resetPasswordOtp?: string;
  resetPasswordOtpExpireAt?: Date;
  refreshToken?: string;
  isActive: boolean;
  profileStatus?: string;
  isPasswordValid(password: string): Promise<boolean>;
  generateOtp(type: string): string;
  generateAccessToken(): string;
  generateRefreshToken(): string;
}

const UserSchema: Schema = new Schema(
  {
    firstName: {
      type: String,
      required: true,
      trim: true,
    },
    lastName: {
      type: String,
      required: true,
      trim: true,
    },
    email: {
      type: String,
      required: true,
      unique: true,
      trim: true,
      lowercase: true,
    },
    password: {
      type: String,
      required: true,
    },
    image: {
      type: String,
      default:"data:image/jpeg;base64,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"
    },
    phone: {
      type: String,
      required: true,
    },
    role: {
      type: String,
      enum: Object.values(UserRole),
      required: true,
      default: UserRole.PATIENT,
    },
    isEmailVerified: {
      type: Boolean,
      default: false,
    },
    verifyOtp: {
      type: String,
    },
    verifyOtpExpireAt: {
      type: Date,
    },
    resetPasswordOtp: {
      type: String,
    },
    resetPasswordOtpExpireAt: {
      type: Date,
    },
    refreshToken: {
      type: String,
    },
    isActive: {
      type: Boolean,
      default: true,
    },
  },
  { discriminatorKey: "role", timestamps: true }
);

UserSchema.pre<IUser>("save", async function () {
  if (!this.isModified("password")) return;
  this.password = await bcrypt.hash(this.password, 10);
});

UserSchema.methods.isPasswordValid = async function (password: string) {
  return await bcrypt.compare(password, this.password);
};

UserSchema.methods.generateOtp = function (type = "verification") {
  const otp = Math.floor(100000 + Math.random() * 900000).toString();

  if (type === "verification") {
    this.verifyOtp = otp;
    this.verifyOtpExpireAt = new Date(Date.now() + 2 * 60 * 1000); // 2 minutes
  } else if (type === "reset") {
    this.resetPasswordOtp = otp;
    this.resetPasswordOtpExpireAt = new Date(Date.now() + 2 * 60 * 1000); // 2 minutes
  }

  return otp;
};

UserSchema.methods.generateAccessToken = function () {
  return jwt.sign(
    { _id: this._id, role: this.role },
    process.env.ACCESS_TOKEN_SECRET as string,
    { expiresIn: AccessTokenExpire }
  );
};

UserSchema.methods.generateRefreshToken = function () {
  return jwt.sign(
    { _id: this._id },
    process.env.REFRESH_TOKEN_SECRET as string,
    { expiresIn: RefreshTokenExpire }
  );
};

export const registerValidation = Joi.object({
  firstName: Joi.string().min(3).max(50).required().messages({
    "string.empty": "Name is required",
    "string.min": "Name must be at least 3 characters",
  }),
  lastName: Joi.string().min(3).max(50).required().messages({
    "string.empty": "Name is required",
    "string.min": "Name must be at least 3 characters",
  }),
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
  password: Joi.string().min(8).required().messages({
    "string.empty": "Password is required",
    "string.min": "Password must be at least 8 characters",
  }),
  confirmPassword: Joi.string().required().valid(Joi.ref("password")).messages({
    "any.only": "Passwords must match",
    "string.empty": "Confirm password is required",
  }),
  phone: Joi.string()
    .pattern(/^[0-9+]+$/)
    .min(10)
    .max(15)
    .required()
    .messages({
      "string.pattern.base": "Phone must contain only numbers and +",
      "string.empty": "Phone is required",
    }),
  role: Joi.string()
    .valid(...Object.values(UserRole))
    .default(UserRole.PATIENT)
    .messages({
      "any.only": "Role must be one of: patient, doctor",
    }),
});

export const loginValidation = Joi.object({
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
  password: Joi.string().required().messages({
    "string.empty": "Password is required",
  }),
});

export const forgotPasswordValidation = Joi.object({
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
});

export const verifyResetOtpValidation = Joi.object({
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
  resetPasswordOtp: Joi.string()
    .length(6)
    .pattern(/^\d+$/)
    .required()
    .messages({
      "string.empty": "OTP is required",
      "string.length": "OTP must be 6 digits",
      "string.pattern.base": "OTP must contain only numbers",
    }),
});

export const resetPasswordValidation = Joi.object({
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
  password: Joi.string().min(8).required().messages({
    "string.empty": "Password is required",
    "string.min": "Password must be at least 8 characters",
  }),
  confirmPassword: Joi.string().required().valid(Joi.ref("password")).messages({
    "any.only": "Passwords must match",
    "string.empty": "Confirm password is required",
  }),
});

export const resendOtpValidation = Joi.object({
  email: Joi.string().email().required().messages({
    "string.empty": "Email is required",
    "string.email": "Invalid email format",
  }),
  type: Joi.string()
    .valid("reset", "verification")
    .required()
    .messages({
      "any.only": "Type must be either reset or verification",
    }),
});

export const User = mongoose.model<IUser>("User", UserSchema);

export default User;
